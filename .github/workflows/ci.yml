name: CI/CD Pipeline - P&S Tech Oficina API

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  release:
    types: [published]

env:
  NODE_VERSION: '20'
  YARN_VERSION: '1.22.19'

jobs:
  # ================================
  # VALIDATE STAGE
  # ================================
  validate:
    name: ğŸ” Validar CÃ³digo
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: ğŸ“¥ Instalar dependÃªncias
        run: yarn install --frozen-lockfile

  # ================================
  # TEST STAGE
  # ================================
  unit-tests:
    name: ğŸ§ª Testes UnitÃ¡rios
    runs-on: ubuntu-latest
    needs: validate

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      NODE_ENV: test
      DB_HOST: localhost
      DB_PORT: 5432
      DB_USERNAME: test_user
      DB_PASSWORD: test_password
      DB_DATABASE: test_db
      DB_SCHEMA: public
      REDIS_HOST: localhost
      REDIS_PORT: 6379
      JWT_SECRET: test_secret_key_for_testing_only
      JWT_EXPIRES_IN: 1h
      DOCUMENTATION_PREFIX: /api
      SMTP_HOST: smtp.test.com
      PORT_EMAIL: 587
      SECURE_EMAIL: false
      USER_EMAIL: test@test.com
      PASS_EMAIL: test_password
      SERVER_URL: http://localhost:3333

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: ğŸ“¥ Instalar dependÃªncias
        run: yarn install --frozen-lockfile

      - name: â³ Aguardar PostgreSQL
        run: |
          echo "â³ Aguardando PostgreSQL..."
          timeout 30 bash -c 'until nc -z localhost 5432; do sleep 1; done'
          echo "âœ… PostgreSQL estÃ¡ rodando!"

      - name: â³ Aguardar Redis
        run: |
          echo "â³ Aguardando Redis..."
          timeout 30 bash -c 'until nc -z localhost 6379; do sleep 1; done'
          echo "âœ… Redis estÃ¡ rodando!"

      - name: ğŸ—„ï¸ Executar migrations
        run: yarn typeorm-ts-node-commonjs migration:run -d src/config/database/data-source.ts

      - name: ğŸ§ª Executar testes unitÃ¡rios
        run: yarn test --coverage --watchAll=false

      - name: ğŸ“Š Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  integration-tests:
    name: ğŸ”— Testes de IntegraÃ§Ã£o
    runs-on: ubuntu-latest
    needs: validate

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      NODE_ENV: test
      DB_HOST: localhost
      DB_PORT: 5432
      DB_USERNAME: test_user
      DB_PASSWORD: test_password
      DB_DATABASE: test_db
      DB_SCHEMA: public
      REDIS_HOST: localhost
      REDIS_PORT: 6379
      JWT_SECRET: test_secret_key_for_testing_only
      JWT_EXPIRES_IN: 1h
      DOCUMENTATION_PREFIX: /api
      SMTP_HOST: smtp.test.com
      PORT_EMAIL: 587
      SECURE_EMAIL: false
      USER_EMAIL: test@test.com
      PASS_EMAIL: test_password
      SERVER_URL: http://localhost:3333

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: ğŸ“¥ Instalar dependÃªncias
        run: yarn install --frozen-lockfile

      - name: â³ Aguardar PostgreSQL
        run: |
          echo "â³ Aguardando PostgreSQL..."
          timeout 30 bash -c 'until nc -z localhost 5432; do sleep 1; done'
          echo "âœ… PostgreSQL estÃ¡ rodando!"

      - name: â³ Aguardar Redis
        run: |
          echo "â³ Aguardando Redis..."
          timeout 30 bash -c 'until nc -z localhost 6379; do sleep 1; done'
          echo "âœ… Redis estÃ¡ rodando!"

      - name: ğŸ—„ï¸ Executar migrations
        run: yarn typeorm-ts-node-commonjs migration:run -d src/config/database/data-source.ts

      - name: ğŸ§ª Executar testes E2E
        run: yarn test:e2e --detectOpenHandles

  # ================================
  # SECURITY STAGE
  # ================================
  security:
    name: ğŸ”’ AnÃ¡lise de SeguranÃ§a
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: ğŸ“¥ Instalar dependÃªncias
        run: yarn install --frozen-lockfile

      - name: ğŸ”’ Auditoria de seguranÃ§a
        run: yarn audit --level high

  # ================================
  # BUILD STAGE
  # ================================
  build:
    name: ğŸ—ï¸ Build Docker
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, security]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ” Login no Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ—ï¸ Build e Push da imagem
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/ps-tech-api:latest
            ${{ secrets.DOCKER_USERNAME }}/ps-tech-api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ================================
  # DEPLOY STAGE
  # ================================
  deploy-staging:
    name: ğŸš€ Deploy Staging
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, security]
    if: github.ref == 'refs/heads/develop'
    environment: staging

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy para Staging
        run: |
          echo "ğŸš€ Deployando para staging..."
          echo "ğŸ“‹ InformaÃ§Ãµes do deploy:"
          echo "  - Branch: ${{ github.ref_name }}"
          echo "  - Commit: ${{ github.sha }}"
          echo "  - Autor: ${{ github.actor }}"
          echo "  - Data: $(date)"
          echo "âœ… Deploy para staging concluÃ­do"

  deploy-production:
    name: ğŸš€ Deploy ProduÃ§Ã£o
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    environment: production

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy para ProduÃ§Ã£o
        run: |
          echo "ğŸš€ Deployando para produÃ§Ã£o..."
          echo "ğŸ“‹ InformaÃ§Ãµes do deploy:"
          echo "  - Branch: ${{ github.ref_name }}"
          echo "  - Commit: ${{ github.sha }}"
          echo "  - Autor: ${{ github.actor }}"
          echo "  - Data: $(date)"
          echo "âœ… Deploy para produÃ§Ã£o concluÃ­do"

  # ================================
  # NOTIFICATIONS
  # ================================
  notify:
    name: ğŸ“¢ NotificaÃ§Ãµes
    runs-on: ubuntu-latest
    needs:
      [
        unit-tests,
        integration-tests,
        security,
        build,
        deploy-staging,
        deploy-production,
      ]
    if: always()

    steps:
      - name: ğŸ“¢ NotificaÃ§Ã£o de sucesso
        if: success()
        run: |
          echo "ğŸ‰ Pipeline executado com sucesso!"
          echo "ğŸ“Š Resumo:"
          echo "  - Branch: ${{ github.ref_name }}"
          echo "  - Commit: ${{ github.sha }}"
          echo "  - Autor: ${{ github.actor }}"

      - name: ğŸ“¢ NotificaÃ§Ã£o de falha
        if: failure()
        run: |
          echo "âŒ Pipeline falhou!"
          echo "ğŸ“Š Resumo:"
          echo "  - Branch: ${{ github.ref_name }}"
          echo "  - Commit: ${{ github.sha }}"
          echo "  - Autor: ${{ github.actor }}"
